<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Mini Fingerprint</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 800px; margin: 24px auto; padding: 0 12px; }
      h1 { margin-bottom: 4px; }
      .muted { color: #666; font-size: 0.9rem; margin-top: 0; }
      pre { background: #f7f7f7; padding: 12px; border-radius: 8px; overflow: auto; }
      .row { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
      .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #eef; }
      .ok { background: #e8f7ec; }
      .warn { background: #fff3cd; }
      button { padding: 8px 12px; }
    </style>
  </head>
  <body>
    <h1>Mini Fingerprint</h1>
    <p class="muted">This demo collects non-PII browser traits, hashes them (with a server salt), and shows your fingerprint.</p>

    <div class="row">
      <button id="refresh">Refresh / Recompute</button>
      <span id="stability" class="badge">Checkingâ€¦</span>
    </div>

    <h3>Current fingerprint</h3>
    <pre id="fp">â€¦</pre>

    <h3>Collected traits</h3>
    <pre id="traits">â€¦</pre>

    <script>
      function boolTry(fn) { try { return !!fn(); } catch { return false; } }

      async function getWebGLInfo() {
        try {
          const canvas = document.createElement('canvas');
          let gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
          if (!gl) return { vendor: null, renderer: null, api: null };

          const dbg = gl.getExtension('WEBGL_debug_renderer_info');
          const vendor = dbg ? gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL) : null;
          const renderer = dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : null;
          return { vendor, renderer, api: gl instanceof WebGL2RenderingContext ? 'webgl2' : 'webgl' };
        } catch {
          return { vendor: null, renderer: null, api: null };
        }
      }

      async function canvasHash() {
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        c.width = 200; c.height = 50;
        ctx.textBaseline = 'top';
        ctx.font = '16px Arial';
        ctx.fillStyle = '#f60'; ctx.fillRect(0,0,200,50);
        ctx.fillStyle = '#069'; ctx.fillText('fp demo ðŸ˜Š', 2, 2);
        // quick digest from data URL
        const str = c.toDataURL();
        let h = 0;
        for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) >>> 0;
        return h.toString(16);
      }

      async function collectTraits() {
        const nav = navigator, scr = screen;
        const webgl = await getWebGLInfo();
        const traits = {
          userAgent: nav.userAgent || '',
          platform: nav.platform || '',
          languages: nav.languages || [nav.language].filter(Boolean),
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
          screen: { w: scr.width, h: scr.height, dpr: window.devicePixelRatio || 1, depth: scr.colorDepth || 0 },
          hw: { cores: nav.hardwareConcurrency || null, memGB: nav.deviceMemory || null, maxTouchPoints: nav.maxTouchPoints || 0 },
          storage: {
            local: boolTry(() => (localStorage.setItem('t','1'), localStorage.removeItem('t'), true)),
            session: boolTry(() => (sessionStorage.setItem('t','1'), sessionStorage.removeItem('t'), true)),
            cookie: navigator.cookieEnabled === true
          },
          canvas: await canvasHash(),
          webgl // { vendor, renderer, api }
        };
        return traits;
      }

      async function compute() {
        const traits = await collectTraits();
        document.getElementById('traits').textContent = JSON.stringify(traits, null, 2);

        const res = await fetch('/fp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: traits })
        });
        const data = await res.json();
        const fp = data.fp || '(error)';
        document.getElementById('fp').textContent = fp;

        // stability check via localStorage
        const last = localStorage.getItem('last_fp');
        const stability = document.getElementById('stability');
        if (last && last === fp) {
          stability.textContent = 'Stable: same as last visit';
          stability.className = 'badge ok';
        } else if (last && last !== fp) {
          stability.textContent = 'Changed since last visit';
          stability.className = 'badge warn';
        } else {
          stability.textContent = 'First seen (no previous fp)';
          stability.className = 'badge';
        }
        localStorage.setItem('last_fp', fp);
      }

      document.getElementById('refresh').addEventListener('click', compute);
      compute();
    </script>
  </body>
</html>
